---
title: "Project - part 1"
author: "Sandy Vo"
date: "7/22/2022"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#The data file has 303 records and 14 variables
```{r}
df <- read.csv("heart-disease.csv")
head(df)
dim(df)
```

#Change the age column name
```{r}
colnames(df)
names(df)[names(df) == "ï..age"] <- "age"
```

There is 2 identical rows in the dataset. After removing the duplicate values, the dataset has 302 observations.

```{r}
df[duplicated(df),]
df <- df[!duplicated(df),]
dim(df)

```

Check if each field in the data is numeric or not

The dataset has 9 categorical variables; however, the dataset failed to classify them. They are all displayed in numeric values.

```{r}
apply(df,2,is.numeric)

```

```{r}
lapply(apply(df,2, unique),length)

```

Errors in variables ca and thal:

ca has 4 levels corresponding to 0, 1, 2 and 3. But the dataset fails to classify categorical variables. There is 4 rows in the dataset marked with 4. So I replace 4 with the median of the variable ca.

thal has 3 levels (1,2, and 3). But the dataset fails to classify categorical variables. There is 2 rows in the dataset marked with 0. So I replace 0 with the median of the variable thal.


```{r}
table(df$ca)
```

```{r}

df[df$ca == 4,]$ca = NA
unique(df$ca)
```
```{r}
table(df$thal)
df[df$thal == 0,]$thal = NA
unique(df$thal)
```

```{r}
apply(apply(df,2,is.na),2,sum)
```



```{r}
df$ca[is.na(df$ca)] <- median(df$ca, na.rm = TRUE)
df$thal[is.na(df$thal)] <- median(df$thal, na.rm = TRUE)
```

Replace numbers in categorical variables with meaningful tags.

```{r}
library(car)

str(df)
df$sex <- recode(df$sex, "0 = 'Female'; 1 = 'Male'")
df$cp <- recode(df$cp, "0 = 'typical_angina'; 1 = 'atypical_angina'; 2 = 'non-anginal pain'; 3 = 'asymtomatic'")
df$fbs <- recode(df$fbs, "0 = 'No'; 1 = 'Yes'")
df$restecg <- recode(df$restecg, "0 = 'Normal'; 1 = 'Abnormal'; 2 = 'Ventricular_hypertrophy'")
df$exang <- recode(df$exang, "0 = 'No'; 1 = 'Yes'")
df$slope <- recode(df$slope, "0 = 'upsloping'; 1 = 'flat'; 2 = 'downsloping'")
df$thal <- recode(df$thal, "1 = 'normal'; 2 = 'fixed_defect'; 3 = 'reversable_defect'")
df$target <- recode(df$target, "0 = 'No'; 1 = 'Yes'")
cols <- c("sex","cp","fbs", "restecg", "exang", "slope", "ca", "thal", "target")
df[cols] <- lapply(df[cols], factor)

str(df)
```

```{r}
library(reshape)
meltData <- melt(df)
library(ggplot2)
library(ggthemes)
p <- ggplot(meltData, aes(variable, value)) 
p + geom_boxplot() + facet_wrap(~variable, scale="free") + ggtitle("Numerical variables") +  theme(plot.title = element_text(hjust = 0.5)) + theme_wsj()
```

Apart from age, the are some outliers that will potentially affect the accuracy of the prediction model. So we have to detele them.

```{r}
#create a function to remove outliers
continous_features = c('trestbps','age','chol','thalach','oldpeak') 
outliers <- function(df_out, group, drop){
    for (each_feature in colnames(df_out[,group])){
        feature_data = df_out[[each_feature]]
       
        Q = quantile(feature_data, probs = c(0.25, 0.75))
        
        IQR = Q[2] - Q[1]
        
        outlier_step = IQR*1.5 
        outlier = which(feature_data < (Q[1] - outlier_step) | feature_data > (Q[2] + outlier_step))
        if (drop == FALSE){
        print(sprintf("For the feature %s, No of Outliers is %.0f",each_feature, length(outlier)))}
        else{
          if (length(outlier) == 0){next}
          else{df_out <- df_out[-outlier,]
          }
          }
        } 
  return(df_out)
    }

df_output <- outliers(df, continous_features ,drop = TRUE)


```

After removing outliers, the dataset is left with 283 observations.


```{r}
library(broom)
library(tidyverse)
library(ggplot2)
```


```{r}
model <- glm(target ~., data = df, 
               family = binomial)

model.data <- augment(model) %>% 
  mutate(index = 1:n()) 

ggplot(model.data, aes(index, .std.resid)) + 
  geom_point(aes(color = target), alpha = .5) +
  theme_bw() + labs(color = "Heart disease")

```

The scatter plot above shows the relationship between the studentized residuals of the logistic regression with target as a response and the other variables as predictors.

Observations whose studentized residuals are greater than 3 in absolute value are
possible outliers. We can see that all the observations’ studentized residuals stays within -2 and 2. So there are no outliers left in the dataset.

```{r}
df <- df_output
dim(df)

ggplot(df, aes(x = target, fill = target)) +
  geom_bar() +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white") +
  ggtitle("Heart Disease Classes") + theme(plot.title = element_text(hjust = 0.5)) + 
  xlab("Sufferring of Heart disease") + ylab("Number of individuals") + theme_economist() + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))
  
```

We have 158 examples where someone has heart disease based on their health parameters and 125 examples where someone doesn't have heart disease. So that's a quite balanced classification problem.

```{r}
pairs(df[,continous_features], col= hcl.colors(2, "Temps")[df$target])
```

```{r}
library(GGally)

ggpairs(df, columns = continous_features, aes(color = target, alpha = 0.5),
        upper = list(continuous = wrap("cor", size = 2.5)))


```

- oldpeak having a linear separation relation between disease and non-disease.
- thalach having a mild separation relation between disease and non-disease.
- Other features don’t form any clear separation

```{r}
library(dplyr)
t1 <- df %>%                       
  group_by(sex,target) %>% 
  dplyr::summarize(count = n())
  

ggplot(t1, aes(sex, count, fill = target)) + 
  geom_col(position = "dodge") +
  geom_text(aes(label = count),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9)) +
  theme_bw() + 
xlab("Sex") + ylab("Frequency") + ggtitle("Sex Distribution according to Heart disease status") + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))
 
```

```{r}
df %>%group_by(sex, target) %>%
summarise(cnt = n()) %>%
mutate(freq = (cnt / sum(cnt)))

```

The graph show that there is an imbalance in sex (only 85 women out of 283
individuals).

Looking at the graph, we can observe that, in among each subgroup of sex, only 20% of female is patient, while it is 54.54% of patients in male subgroup.
So it can be concluded that female is more likely to suffer from heart disease than male (as shown in the dataset).

```{r}

t2 <- df %>%                       
  group_by(cp,target) %>% 
  dplyr::summarize(count = n())
  

ggplot(data = t2, aes(cp, count, fill = target)) + 
    geom_col(position = "dodge") +
  geom_text(aes(label = count),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9))  + xlab("Chest pain type") + ylab("Frequency") + ggtitle("Chest Pain Distribution according to Target") + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5)) + theme(axis.text.x = element_text(angle = 45, hjust=1))
 
```


```{r}
df %>%group_by(cp, target) %>%
summarise(count = n()) %>%
mutate(percent = (count / sum(count)))

```

We all think that chest pain of all types are one of the important symptoms of heart diseases. Surprisingly, while it is true for typical-anginal; asymptomatic, atypical angina and non-anginal pain do not cause heart diseases (at least in the dataset). According to the table, the proportion of patient in each subgroup of chest pain type, asymptomatic, atypical angina and non-anginal pain is 68.18%, 83.67% and 79.27% respectively (much higher than 50%). 

However, only 28.46% of patient is typical-anginal (about 1/3 of non-patient in this subgroup). So chest pain might be a strong predictor of heart diseases.

In addition, chest pain is also imbalanced, which is 130 out of 283 observations is
typical_angina (nearly 50%). The smallest proportion is for asymptomatic (only 22 out of 283 observations).


```{r}
t3 <- df %>%                       
  group_by(fbs,target) %>% 
  dplyr::summarize(count = n())
  

ggplot(data = t3, aes(fbs, count, fill = target)) + 
    geom_col(position = "dodge") +
  geom_text(aes(label = count),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9)) + xlab("Fasting blood sugar") + ylab("Frequency") + ggtitle("Fasting blood sugar \n distribution according to Heart disease") + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))

```
It is noticeable that the number of people with non fasting blood sugar is much higher than that number of people with fasting blood sugar.

```{r}
df %>%group_by(fbs, target) %>%
summarise(count = n()) %>%
mutate(percent = (count / sum(count)))

```

Looking at the table, we can see that the proportion of patient in each subgroup of fbs is quite equal to that of non-patients, which indicates that fbs may not a strong predictor (at least in this dataset).


```{r}
t4 <- df %>%                       
  group_by(slope,target) %>% summarise(count = n())
  

ggplot(data = t4, aes(slope, count, fill = target)) + 
    geom_col(position = "dodge") +
  geom_text(aes(label = count),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9)) + xlab("Slope") + ylab("Frequency") + ggtitle("Slope of the peak exercise ST segment \n distribution according to Heart disease") + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))


```

Firstly, it can be observed that upsloping accounts for a small amount in slope, which means that slope is imbalanced.


```{r}

df %>%group_by(slope, target) %>%
summarise(count = n()) %>%
mutate(percent = (count / sum(count)))

```

Secondly, in downsloping, the number of patients is nearly triple that of non-patients while in flat (75.18% compared to 24.82%), the former is just above half of the latter (63.85% compared to 36.15%). In upsloping, there is no difference between the former and the latter (50% each).

So if a person has downsloping or flat, he or she is more likely to have heart disease but we can not say anything if a person has upsloping.

```{r}
t5 <- df %>%                       
  group_by(exang,target) %>% 
  dplyr::summarize(count = n())
  

ggplot(data = t5, aes(exang, count, fill = target)) + 
    geom_col(position = "dodge") +
  geom_text(aes(label = count),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9)) + xlab("Exercise induced angina") + ylab("Frequency") + ggtitle("Exercise induced angina \n distribution according to Heart disease") + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))


```

```{r}
t6 <- df %>%                       
  group_by(restecg,target) %>% 
  dplyr::summarize(count = n())
  

ggplot(data = t6, aes(restecg, count, fill = target)) + 
    geom_col(position = "dodge") +
  geom_text(aes(label = count),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9)) + xlab("Resting electrocardiographic results") + ylab("Frequency") + ggtitle("Resting electrocardiographic results \n distribution according to Heart disease") + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))

```

We can see that restecg is imbalanced, only 2 out of 283 observations belongs to
ventricular_hypertrophy, while it is it is 137 and 144 for normal and abnormal subgroup.

```{r}

df %>%group_by(restecg, target) %>%
summarise(count = n()) %>%
mutate(percent = (count / sum(count)))

```

In abnormal, we can see that the proportion of patient 2 times that of non-patient.

However, the other 2 subgroups of restecg experience equal proportions in patient and non-patient.

It may not a good predictor as I can not find any patterns from this variable.

```{r}
t7 <- df %>%                       
  group_by(ca,target) %>% 
  dplyr::summarize(count = n())
  

ggplot(data = t7, aes(ca, count, fill = target)) + 
    geom_col(position = "dodge") +
  geom_text(aes(label = count),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9)) + xlab("Number of major vessels") + ylab("Frequency") + ggtitle("Number of major vessels \n distribution according to Heart disease") + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))

```

Firstly, ca is imbalanced (169 out of 283 individuals has 0 major vessels colored by fluoroscopy, which is over 50%). While only 63, 35 and 16 people have 1,2 and 3 major vessels colored by fluoroscopy respectively.


```{r}
df %>%group_by(ca, target) %>%
summarise(count = n()) %>%
mutate(percent = (count / sum(count)))

```

In addition, subgroup 1,2 and 3 experience the same pattern, which means that there is a much higher proportion of non-patient compared to patient. But the opposite happens in subgroup 0 (75% of patient compared to 25% of non-patient). So a person with no vessels colored by fluoroscopy is more likely to suffer from heart disease.

So ca might be a strong predictor of heart disease.

```{r}
t8 <- df %>%                       
  group_by(thal,target) %>% 
  dplyr::summarize(count = n())
  

ggplot(data = t8, aes(thal, count, fill = target)) + 
    geom_col(position = "dodge") +
  geom_text(aes(label = count),
    colour = "white", size = 3,
    vjust = 1.5, position = position_dodge(.9)) + xlab("Thalium stress result") + ylab("Frequency") + ggtitle("Thalium stress result \n distribution according to Heart disease") + labs(fill = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))

```

Firstly, thal is imbalanced (only 17 out of 283 observations is subgroup normal while is it 161 and 105 for subgroup fixed_defect and reversable_defect, respectively.


```{r}

df %>%group_by(thal, target) %>%
summarise(count = n()) %>%
mutate(percent = (count / sum(count)))

```

Additionally, in subgroup fixed_defect, the proportion of patient is three times that of non-patient while in the other 2 subgroups, the proportion of patient is only about half of non-patient. So patients with fixed defect have a significantly higher incidence of heart disease.

So thal might is a strong predictor as well.

Check skewed data
```{r}
library(Hmisc)
hist.data.frame(df[,continous_features])

```
The plot below indicates some insights: age, trestbps and chol are approximately
normally distributed.

oldpeak is left-skewed while it is right-skewed for thalach.

However, there is no assumption about normality on independent variable in logistic regression. So the skewness of the numerical predictors is not problematic.



```{r}
ggpairs(df[,c('trestbps','age','chol','thalach','oldpeak', 'target')], aes(color = target)) + theme_bw()

```











```
```{r}
ggplot(data = df,aes(x = age, y = thalach, color = target)) + geom_point(alpha = 0.6) + xlab("Age") + ylab("Maximum heart rate") + ggtitle("Heart disease in function of Age and Maximum heart rate") + labs(color = "Heart disease") + theme(plot.title = element_text(hjust = 0.5))

```
